---
name: refactor-protocol
description: 當使用者要求重構 (Refactor)、優化 (Optimize) 或改善現有代碼結構時使用。
---

# Refactor Protocol (重構流程規範)

此 Skill 用於規範代碼重構流程，強制執行「先分析影響，後執行重構」的原則，避免破壞性變更。

## 核心規則 (Core Rules)

1. **語言要求**：所有分析報告與溝通必須使用 **zh-TW**。
2. **禁止搶跑**：在使用者明確 **Approve (批准)** 重構方案之前，**嚴格禁止**直接修改專案原始碼。
3. **檔案優先 (File Only)**：
   - **必須**將完整的分析報告存檔至 `doc/refactor/`。
   - **禁止**在對話視窗中輸出報告全文。
   - 僅需告知使用者：「重構分析報告已建立，請查看：[檔案路徑]」。
4. **影響範圍優先**：重構前必須完整識別所有受影響的模組與調用方。

## 執行流程 (Workflow)

### 第一階段：範圍分析 (Scope Analysis)

當使用者提出重構需求時：

1. **建立檔案**：
   - 在 `doc/refactor/` 目錄下建立一個 Markdown 報告。
   - 命名規則：`Refactor_{YYYYMMDD}_{TargetName}.md`
   - 若目錄不存在，請先建立。

2. **撰寫報告內容**：

   #### 1. 重構目標 (Refactor Goal)
   - 重述使用者的重構意圖（例如：提升可讀性、消除重複、改善效能）。
   - 明確指出目標代碼的位置與範圍。

   #### 2. 現狀分析 (Current State)
   - 描述現有代碼的結構與問題。
   - 附上關鍵代碼片段（標註行號與檔案路徑）。
   - 量化指標（若適用）：Cyclomatic Complexity、重複行數、方法長度等。

   #### 3. 影響範圍評估 (Impact Analysis) ⚠️ 關鍵
   - **直接依賴 (Direct Dependencies)**：列出所有調用此代碼的模組。
   - **間接依賴 (Indirect Dependencies)**：可能受到連鎖影響的模組。
   - **Public API 變更**：是否會破壞對外介面？
   - **測試覆蓋**：現有測試是否足以驗證重構？

   #### 4. 重構方案 (Proposed Approach)
   - **方案 A**：[方案描述]
     - 優點 (Pros)
     - 缺點 (Cons)
     - 預估變更檔案數
   - **方案 B**：[方案描述]（若有替代方案）
     - 優點 (Pros)
     - 缺點 (Cons)
     - 預估變更檔案數
   - **建議方案**：明確指出推薦的方案與理由。

   #### 5. 風險評估 (Risk Assessment)
   - **破壞性風險**：High / Medium / Low
   - **回滾難度**：Easy / Moderate / Hard
   - **需要的驗證步驟**：列出重構後必須執行的測試或檢查。

   #### 6. 執行計畫 (Execution Plan)
   - 分步驟列出重構順序（建議採用小步快跑策略）。
   - 標示可安全的中斷點（若重構中途需要停止）。

3. **通知使用者**：僅需告知使用者：「重構分析報告已建立，請查看：[檔案路徑]」。

### 第二階段：審閱與批准 (Review & Approve)

1. **詢問使用者**：請使用者確認分析是否正確，並選擇重構方案。
2. **補充分析**：如果使用者指出遺漏的影響範圍，請更新報告。

### 第三階段：執行重構 (Execution)

當使用者明確表示「批准」或「開始重構」(Approve) 後：

1. **依計畫執行**：嚴格按照報告中的執行計畫順序進行。
2. **小步提交**：建議每完成一個步驟就進行 Commit（若使用版本控制）。
3. **驗證步驟**：每步完成後，執行報告中列出的驗證步驟。

### 第四階段：完成確認 (Completion)

1. **更新報告**：在報告末尾新增「執行結果」區塊，記錄：
   - 實際變更的檔案清單
   - 遇到的問題與解決方式
   - 最終驗證結果
2. **歸檔**：若專案有 Tracker 機制，同步更新進度。

## 重構類型指引 (Refactor Type Guide)

| 重構類型 | 風險等級 | 特別注意事項 |
|---------|---------|-------------|
| 重命名 (Rename) | Low | 確認所有引用點、字串拼接、反射調用 |
| 提取方法 (Extract Method) | Low | 確認參數傳遞、回傳值、副作用 |
| 內聯方法 (Inline Method) | Low | 確認調用點數量 |
| 移動方法 (Move Method) | Medium | 確認 namespace、依賴注入、存取修飾詞 |
| 提取類別 (Extract Class) | Medium | 確認職責劃分、依賴關係 |
| 改變介面 (Change Interface) | High | 必須同步所有實作、呼叫端 |
| 改變繼承結構 | High | 必須驗證所有子類別行為 |

## 觸發時機 (When to use)

- 使用者說：「幫我重構這段代碼」
- 使用者說：「這個類別太大了，幫我拆分」
- 使用者說：「優化這個方法的結構」
- 使用者說：「消除這些重複代碼」
- 使用者說：「改善這個模組的可讀性」

## 禁止事項 (Don'ts)

1. ❌ 未分析影響範圍就開始修改代碼
2. ❌ 重構過程中順便「改善」不相關的代碼
3. ❌ 跳過驗證步驟
4. ❌ 一次性大規模重構而不分步驟
5. ❌ 忽略使用者對影響範圍的補充意見
