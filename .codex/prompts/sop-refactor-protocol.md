# Refactor Protocol for OpenAI Codex

此規則為 Codex 執行代碼重構的行為規範。

## 核心規則 (Core Rules)

1. **語言要求**：所有溝通、文件撰寫必須使用 **zh-TW**。
2. **禁止搶跑**：在使用者明確表示「批准」或「Approve」之前，**禁止修改專案代碼**。
3. **影響優先**：必須先完成影響範圍分析，才能提出重構方案。

## 觸發條件 (When to Activate)

當使用者說出以下類型的請求時，啟動此流程：
- 「幫我重構...」
- 「優化這段代碼」
- 「這個類別/方法太大了」
- 「消除重複代碼」

## 執行流程 (Workflow)

### 第一階段：影響分析

1. **搜尋依賴**：
   - 使用工具搜尋所有調用目標代碼的位置。
   - 識別 Public API 是否會變更。

2. **建立報告**：
   - 在 `doc/refactor/` 建立 `Refactor_{YYYYMMDD}_{Target}.md`。
   - 包含：現狀分析、影響範圍、方案比較、風險評估。

3. **等待批准**：
   - 列出分析結果後，**必須暫停**，請使用者確認。

### 第二階段：執行重構

1. **小步快跑**：每個變更步驟獨立執行，便於回滾。
2. **驗證每步**：確認編譯通過、測試通過。
3. **記錄變更**：在報告中更新實際變更清單。

## 輸出規範

| 項目 | 路徑 |
|------|------|
| 重構報告 | `doc/refactor/Refactor_{Date}_{Target}.md` |

## 禁止事項 (Don'ts)

1. 未經批准就修改代碼
2. 跳過影響範圍分析
3. 重構時順便改不相關的代碼
4. 一次性大改而不分步驟
